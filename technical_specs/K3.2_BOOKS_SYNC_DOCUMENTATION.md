# AXV K3.2 - BOOKS_SYNC System Documentation

**Version:** 1.0 PRODUCTION  
**Status:** âœ… OPERATIONAL  
**Date:** 2025-11-14  
**Owner:** Aster (with Claude & VoyTech)

---

## ğŸ“‹ Table of Contents

1. [System Overview](#system-overview)
2. [Architecture](#architecture)
3. [Components](#components)
4. [Setup Guide](#setup-guide)
5. [Operations Manual](#operations-manual)
6. [Troubleshooting](#troubleshooting)
7. [Maintenance](#maintenance)
8. [Technical Reference](#technical-reference)

---

## System Overview

### What is BOOKS_SYNC?

BOOKS_SYNC is an automated book indexing system that:
- Scans Google Drive folder for technical books (PDF, EPUB, MOBI, etc.)
- Extracts metadata (title, authors, language, category, tags)
- Syncs to Google Sheets via n8n webhook
- Maintains incremental updates (no duplicates)
- Uses sequential IDs: `axv_001`, `axv_002`, `axv_003`...

### Key Features

âœ… **Automatic metadata extraction**
- Language detection (PL, EN, DE, RU, UK)
- Category classification (11 categories: Networking, DevOps, Programming, etc.)
- Tag generation (100+ keywords)
- Author extraction from filename

âœ… **Incremental sync**
- Only new books are synced
- No duplicates
- Preserves manual edits (status, priority, notes)

âœ… **Production ready**
- Error handling
- Logging
- Daily automation option
- Test functions

---

## Architecture

### High-Level Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Google Drive   â”‚
â”‚   (Kompendium)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Scan files
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Google Apps     â”‚
â”‚ Script (GAS)    â”‚
â”‚                 â”‚
â”‚ - Scan folders  â”‚
â”‚ - Extract meta  â”‚
â”‚ - Filter books  â”‚
â”‚ - Build JSON    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ POST JSON
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  n8n Webhook    â”‚
â”‚  /books-sync    â”‚
â”‚                 â”‚
â”‚ - Validate      â”‚
â”‚ - Extract books â”‚
â”‚ - Map to rows   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Append rows
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Google Sheets   â”‚
â”‚  Books Index    â”‚
â”‚                 â”‚
â”‚ - axv_001       â”‚
â”‚ - axv_002       â”‚
â”‚ - ...           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow

1. **Trigger:** Manual run or daily trigger (2 AM)
2. **Scan:** GAS scans Drive folder recursively
3. **Filter:** Only book files (.pdf, .epub, .mobi, etc.)
4. **Extract:** Metadata from filename and location
5. **Compare:** Check what's already in sheet
6. **Sync:** Send only NEW books to n8n
7. **Store:** n8n appends to Google Sheets
8. **Result:** Books Index updated

---

## Components

### 1. Google Apps Script (GAS)

**Location:** `script.google.com` or bound to sheet  
**File:** `gas_books_COMPLETE_FINAL.js`

**Configuration:**
```javascript
const N8N_WEBHOOK_URL = "http://n8n.axv.life:5678/webhook/books-sync";
const KOMPENDIUM_FOLDER_ID = "1QXIFCCLwyKWRfa9amZ-zy6-3aP7mPrNR";
const BOOKS_INDEX_SHEET_ID = "1f1crSdpFv0ZUsHvXKg0uQDNjUca32TsjHZXrxIiNuGY";
const BOOKS_INDEX_SHEET_NAME = "books_index";
```

**Main Functions:**
- `syncBooksToN8n()` - Incremental sync (use daily)
- `forceFullResync()` - Full resync (use once or when rebuilding)
- `showSyncStats()` - Preview what will sync
- `testDriveScan()` - Test scanning without syncing
- `testSheetAccess()` - Test sheet connection
- `testFolderAccess()` - Test folder connection

### 2. n8n Workflow

**Name:** `AXV - BOOKS_SYNC â†’ Books Index (FINAL FIXED)`  
**Webhook:** `http://n8n.axv.life:5678/webhook/books-sync`  
**File:** `n8n_BOOKS_SYNC_FINAL_FIXED.json`

**Nodes:**
1. Webhook: BOOKS_SYNC (POST)
2. Extract & Validate (Code)
3. Check for Errors (IF)
4. Build Books Index Row (Set)
5. Append to Books Index (Google Sheets)
6. Aggregate Results
7. Build Success Response (Set)
8. Success Response (200)
9. Error Response (400)

**JSON Contract:**
```json
{
  "op": "BOOKS_SYNC",
  "source": "GAS",
  "ts": "2025-11-14T12:00:00+01:00",
  "books": [
    {
      "id": "axv_001",
      "title": "Network Warrior",
      "authors": ["Gary A. Donahue"],
      "lang": "EN",
      "category": "Networking",
      "tags": ["Network", "Cisco", "BGP"],
      "status": "TODO",
      "priority": "N",
      "location": "Drive/Kompendium/Networking",
      "url": "https://drive.google.com/...",
      "notes": "Added: 2025-11-14, Size: 15.2 MB"
    }
  ]
}
```

### 3. Google Sheets

**Name:** `AXV Books Index`  
**Sheet ID:** `1f1crSdpFv0ZUsHvXKg0uQDNjUca32TsjHZXrxIiNuGY`  
**Sheet Name:** `books_index`

**Columns:**
| Column | Description | Example |
|--------|-------------|---------|
| A - Id | Sequential ID | axv_001 |
| B - Title | Book title | Network Warrior |
| C - Authors | Comma-separated | Gary A. Donahue |
| D - Lang | Language code | EN |
| E - Category | Main category | Networking |
| F - Tags | Comma-separated | Network, Cisco, BGP |
| G - Status | Reading status | TODO, READING, DONE |
| H - Priority | Priority level | W, N, L |
| I - Location | Drive path | Drive/Kompendium/Networking |
| J - URL | Drive URL | https://drive.google.com/... |
| K - Notes | Additional info | Added: 2025-11-14, Size: 15 MB |
| L - Sync TS | Last sync time | 2025-11-14T12:00:00+01:00 |

### 4. Google Drive

**Folder:** Kompendium  
**Folder ID:** `1QXIFCCLwyKWRfa9amZ-zy6-3aP7mPrNR`  
**URL:** `https://drive.google.com/drive/folders/1QXIFCCLwyKWRfa9amZ-zy6-3aP7mPrNR`

**Supported file types:**
- PDF (.pdf)
- EPUB (.epub)
- MOBI (.mobi)
- DJVU (.djvu)
- AZW (.azw, .azw3)
- Others (.fb2, .chm, .doc, .docx)

---

## Setup Guide

### Prerequisites

- Google Account with access to:
  - Google Drive (Kompendium folder)
  - Google Sheets (Books Index)
  - Google Apps Script
- n8n instance running (axv.life:5678)
- n8n workflow imported and active

### Initial Setup (One-time)

#### Step 1: Import n8n Workflow

1. Open n8n: `http://n8n.axv.life:5678`
2. Workflows â†’ Import from File
3. Select: `n8n_BOOKS_SYNC_FINAL_FIXED.json`
4. Configure Google Sheets node:
   - Credentials: Select/add Google account
   - Document: "AXV Books Index"
   - Sheet: "books_index"
5. Activate workflow (toggle ON)
6. Copy webhook URL: `http://n8n.axv.life:5678/webhook/books-sync`

#### Step 2: Setup Google Apps Script

1. Go to: `https://script.google.com`
2. New Project â†’ Name: "AXV Books Sync"
3. Paste code from: `gas_books_COMPLETE_FINAL.js`
4. Verify configuration (lines 23-26):
   ```javascript
   const N8N_WEBHOOK_URL = "http://n8n.axv.life:5678/webhook/books-sync";
   const KOMPENDIUM_FOLDER_ID = "1QXIFCCLwyKWRfa9amZ-zy6-3aP7mPrNR";
   const BOOKS_INDEX_SHEET_ID = "1f1crSdpFv0ZUsHvXKg0uQDNjUca32TsjHZXrxIiNuGY";
   const BOOKS_INDEX_SHEET_NAME = "books_index";
   ```
5. Save (Ctrl+S / Cmd+S)

#### Step 3: Run Tests

**Test 1 - Sheet Access:**
```
Function: testSheetAccess
Run
Expected: âœ… Sheet accessed successfully!
```

**Test 2 - Folder Access:**
```
Function: testFolderAccess
Run
Expected: âœ… Folder accessed successfully!
```

**Test 3 - Drive Scan:**
```
Function: testDriveScan
Run
Expected: List of first 5 books with metadata
```

**Test 4 - Preview Sync:**
```
Function: showSyncStats
Run
Expected: Shows what will be synced
```

#### Step 4: First Full Sync

```
Function: forceFullResync
Run
```

**Expected output:**
```
=== FORCE FULL RESYNC ===
Scanning Drive...
Found 47 books

First 5 books:
1. [axv_001] Network Warrior
   EN | Networking | Network, Cisco

Sending 47 books to n8n...
âœ… FULL RESYNC COMPLETE!
Synced: 47 books
```

**Verify:**
1. Open Google Sheets: AXV Books Index
2. Should see all books listed
3. IDs should be: axv_001, axv_002, axv_003...

#### Step 5: Setup Automation (Optional)

**Daily automatic sync at 2 AM:**
```
Function: createDailyTrigger
Run
Expected: âœ… Daily trigger created for 2 AM
```

---

## Operations Manual

### Daily Operations

#### Option 1: Manual Sync

```
1. Open Apps Script
2. Select function: syncBooksToN8n
3. Click Run
4. Check logs for results
```

#### Option 2: Automatic Sync

If daily trigger is set up:
- Runs automatically at 2:00 AM
- No manual intervention needed
- Check logs next morning if needed

### Adding New Books

**Process:**
1. Upload book files to Google Drive (Kompendium folder)
2. Wait for next sync OR run `syncBooksToN8n()` manually
3. Only NEW books will be synced (incremental)
4. Check Google Sheets to verify

**Example:**
```
Before: 47 books in sheet
Add: 3 new PDFs to Drive
Sync: syncBooksToN8n()
After: 50 books in sheet (IDs: axv_048, axv_049, axv_050)
```

### Editing Book Metadata

**Manual edits are preserved!**

You can manually edit in Google Sheets:
- Status: TODO â†’ READING â†’ DONE
- Priority: N â†’ W (Important) or L (Low)
- Notes: Add your own notes
- Category: Override if wrong
- Tags: Add/remove tags

**Next sync will NOT overwrite these changes!**

### Checking Sync Status

```javascript
// Show statistics
showSyncStats()
```

Output:
```
ğŸ“Š Books in Sheet: 47
ğŸ“‚ Books in Drive: 50
âœ¨ New books: 3

ğŸ“š New books:
1. [axv_048] Kubernetes Patterns
   Authors: Bilgin Ibryam
   EN | DevOps | Kubernetes, Docker, Patterns
```

### Viewing Logs

**In Google Apps Script:**
1. Run any function
2. View â†’ Logs (Ctrl+Enter / Cmd+Enter)
3. See detailed execution log

**In n8n:**
1. Click workflow
2. Executions tab
3. See all past runs with input/output

---

## Troubleshooting

### Common Issues

#### Issue 1: "Sheet not found"

**Symptoms:** Error accessing sheet  
**Cause:** Wrong sheet name or ID  
**Fix:**
1. Verify sheet name is exactly: `books_index`
2. Check BOOKS_INDEX_SHEET_ID matches URL
3. Run `testSheetAccess()` to diagnose

#### Issue 2: "Folder not found"

**Symptoms:** Error accessing folder  
**Cause:** Wrong folder ID or no permissions  
**Fix:**
1. Open folder in Drive, copy ID from URL
2. Verify KOMPENDIUM_FOLDER_ID matches
3. Check you have edit permissions
4. Run `testFolderAccess()` to diagnose

#### Issue 3: No books found

**Symptoms:** `Found 0 books`  
**Cause:** No book files in folder or wrong extensions  
**Fix:**
1. Check folder has .pdf, .epub, .mobi files
2. Verify files aren't in shortcuts
3. Check recursive scanning is enabled
4. Run `testDriveScan()` to see what's detected

#### Issue 4: Duplicates appearing

**Symptoms:** Same book appears multiple times  
**Cause:** Using `forceFullResync()` instead of `syncBooksToN8n()`  
**Fix:**
1. Use `syncBooksToN8n()` for daily syncs
2. Only use `forceFullResync()` when rebuilding from scratch
3. Delete duplicate rows manually if needed

#### Issue 5: Wrong metadata

**Symptoms:** Language/category/tags incorrect  
**Cause:** Filename doesn't contain enough info  
**Fix:**
1. Edit manually in Google Sheets (preserved on next sync)
2. Rename file in Drive with more info
3. Add keywords to CATEGORY_KEYWORDS in script
4. Adjust language detection patterns

#### Issue 6: n8n returns 404

**Symptoms:** "webhook is not registered"  
**Cause:** Workflow not active  
**Fix:**
1. Open n8n workflow
2. Toggle "Active" to ON
3. Verify webhook URL is correct
4. Test with curl or Postman

#### Issue 7: n8n returns 400

**Symptoms:** "Invalid request"  
**Cause:** Wrong JSON format  
**Fix:**
1. Run `testPayloadStructure()` in GAS
2. Check logs for malformed JSON
3. Verify `op === "BOOKS_SYNC"`
4. Check books array is not empty

---

## Maintenance

### Regular Tasks

#### Weekly
- Review sync logs for errors
- Check for any failed syncs

#### Monthly
- Review categorization accuracy
- Update CATEGORY_KEYWORDS if needed
- Clean up any duplicate entries

#### Quarterly
- Full audit of Books Index
- Remove deleted books (manual)
- Update language patterns if needed

### Backup

**Google Sheets:**
- Automatic backup via Google Drive version history
- File â†’ Version history â†’ See version history

**Google Apps Script:**
- File â†’ Make a copy (before major changes)
- Export code to local file

**n8n Workflow:**
- Export workflow JSON
- Store in version control (GitHub)

### Updates

**To update GAS code:**
1. Make backup copy first
2. Update code
3. Run test functions
4. Test with small batch first

**To update n8n workflow:**
1. Export current workflow (backup)
2. Make changes
3. Test with manual execution
4. Activate when confirmed working

---

## Technical Reference

### ID Format

**Pattern:** `axv_XXX` where XXX is 3-digit sequential number

**Examples:**
- axv_001
- axv_042
- axv_123

**Generation:**
1. Check existing IDs in sheet
2. Find max number (e.g., 042)
3. Increment by 1 (043)
4. Format with leading zeros (axv_043)

### Language Detection

**Priority order:**
1. Explicit markers: `_pl`, `-en`, `(de)`, `[ru]`
2. Language-specific words: "programowanie", "introduction"
3. Folder path: `/polski/`, `/english/`
4. Publisher: "O'Reilly" â†’ EN
5. Default: EN

**Supported languages:**
- PL (Polish)
- EN (English)
- DE (German)
- RU (Russian)
- UK (Ukrainian)

### Category Classification

**Method:** Keyword scoring system

**Categories (11):**
1. Networking
2. DevOps
3. Programming
4. AI/ML
5. Database
6. Security
7. Cloud
8. Linux
9. Frontend
10. Backend
11. Data
12. General (fallback)

**Scoring:**
- Each keyword match: +1 point
- Keyword in folder path: +3 bonus points
- Category with highest score wins
- Minimum score: 2 (otherwise "General")

### Tag Extraction

**Sources:**
1. All CATEGORY_KEYWORDS (100+ keywords)
2. Specific tags: Beginner, Advanced, Tutorial, etc.
3. Deduplicated (Set)

**Format:** Capitalized first letter

**Examples:**
- "Docker, Kubernetes, Container, Orchestration"
- "Python, Programming, Best practices"

### File Size Formatting

**Logic:**
```
< 1 KB â†’ "XXX B"
< 1 MB â†’ "XX.X KB"
< 1 GB â†’ "XX.X MB"
â‰¥ 1 GB â†’ "XX.X GB"
```

---

## Appendix

### A. Function Reference

#### GAS Main Functions

| Function | Purpose | When to Use |
|----------|---------|-------------|
| `syncBooksToN8n()` | Incremental sync | Daily operations |
| `forceFullResync()` | Full rebuild | First sync or rebuild |
| `showSyncStats()` | Preview changes | Before syncing |
| `testDriveScan()` | Test scanning | Debugging |
| `testSheetAccess()` | Test sheet | Setup/debugging |
| `testFolderAccess()` | Test folder | Setup/debugging |
| `createDailyTrigger()` | Setup automation | One-time setup |

#### GAS Helper Functions

| Function | Purpose |
|----------|---------|
| `getCurrentBooks()` | Get books from sheet |
| `getNextBookId()` | Generate next ID |
| `getBooksFromDrive()` | Scan Drive folder |
| `extractBookMetadata()` | Extract metadata |
| `categorizeBook()` | Determine category |
| `extractTags()` | Generate tags |
| `detectLanguage()` | Detect language |

### B. Configuration Values

**URLs:**
```
n8n Webhook: http://n8n.axv.life:5678/webhook/books-sync
Google Sheets: https://docs.google.com/spreadsheets/d/1f1crSdpFv0ZUsHvXKg0uQDNjUca32TsjHZXrxIiNuGY
Google Drive: https://drive.google.com/drive/folders/1QXIFCCLwyKWRfa9amZ-zy6-3aP7mPrNR
```

**IDs:**
```
Sheet ID: 1f1crSdpFv0ZUsHvXKg0uQDNjUca32TsjHZXrxIiNuGY
Folder ID: 1QXIFCCLwyKWRfa9amZ-zy6-3aP7mPrNR
```

**Names:**
```
Sheet Name: books_index
Project: AXV Books Sync
Workflow: AXV - BOOKS_SYNC â†’ Books Index
```

### C. Supported File Extensions

```javascript
['.pdf', '.epub', '.mobi', '.djvu', '.azw', '.azw3', 
 '.fb2', '.chm', '.doc', '.docx']
```

### D. Status & Priority Values

**Status:**
- `TODO` - Not started
- `READING` - Currently reading
- `DONE` - Finished

**Priority:**
- `W` - WaÅ¼ne (Important/High)
- `N` - Normalne (Normal/Medium) [default]
- `L` - Niskie (Low)
- `R` - Reference (for reference only)

### E. Example Payloads

**Valid sync request:**
```json
{
  "op": "BOOKS_SYNC",
  "source": "GAS",
  "ts": "2025-11-14T12:00:00+01:00",
  "books": [
    {
      "id": "axv_001",
      "title": "Network Warrior",
      "authors": ["Gary A. Donahue"],
      "lang": "EN",
      "category": "Networking",
      "tags": ["Network", "Cisco"],
      "status": "TODO",
      "priority": "N",
      "location": "Drive/Kompendium/Networking",
      "url": "https://drive.google.com/file/d/...",
      "notes": "Added: 2025-11-14, Size: 15.2 MB"
    }
  ]
}
```

**Success response:**
```json
{
  "status": "ok",
  "message": "Books synced successfully",
  "synced_count": 1,
  "sync_ts": "2025-11-14T12:00:00+01:00"
}
```

**Error response:**
```json
{
  "status": "error",
  "message": "Invalid request: op must be 'BOOKS_SYNC'",
  "received_op": "WRONG_OP",
  "books_count": 0
}
```

---

## Change Log

### Version 1.0 (2025-11-14) - PRODUCTION

**Initial release - All systems operational**

**Components:**
- âœ… Google Apps Script: `gas_books_COMPLETE_FINAL.js`
- âœ… n8n Workflow: `n8n_BOOKS_SYNC_FINAL_FIXED.json`
- âœ… Google Sheets: `books_index` configured
- âœ… Google Drive: Kompendium folder connected

**Features:**
- Sequential ID generation (axv_001, axv_002...)
- Incremental sync (no duplicates)
- Multi-language detection (PL, EN, DE, RU, UK)
- 11 category classification
- 100+ keyword tag extraction
- Recursive folder scanning
- Manual edit preservation

**Fixes applied:**
- Sheet name: "Books Index" â†’ "books_index"
- Regex fix: Using includes() instead of regex
- c++ keyword issue resolved
- All configurations verified

**Status:** Production ready, tested, operational âœ…

---

## Support

**For issues or questions:**
- Check Troubleshooting section first
- Review logs in GAS (Ctrl+Enter)
- Check n8n Executions tab
- Contact: AXV Team via #axv-pulse

**Documentation maintained by:** Claude (Backend Engine) & Aster (Owner)

---

**End of Documentation**

*Last updated: 2025-11-14*  
*Document version: 1.0*  
*System status: âœ… OPERATIONAL*
